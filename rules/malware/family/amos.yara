private rule macho {
  strings:
    $not_jar = "META-INF/"
    $not_dwarf = "_DWARF"
    $not_kext = "_.SYMDEF SORTED"
  condition:
    (uint32(0) == 4277009102 or uint32(0) == 3472551422 or uint32(0) == 4277009103 or uint32(0) == 3489328638 or uint32(0) == 3405691582 or uint32(0) == 3199925962 or uint32(0) == 3405691583 or uint32(0) == 3216703178) and none of ($not*)
}

rule amos : critical {
  meta:
    description = "AMOS or Poseidon infostealer (obfuscated)"
	ref = "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
	filetypes = "macho"
	hash = "6427baa1ce5ba37ff6cf3fff79b543018a0a8e8f088c3f66afb24561e4e9de43"
  strings:
	$magic = "_MAGIC_VAR_"
	$header = "mh_execute_header"
	$main = "main" fullword
	$f_system = "@_system"
	$f_setsid = "@_setsid"
	$f_fork = "@_fork"	
    $word_with_spaces = /[a-z]{2,} [a-z]{2,}/
  condition:
	filesize > 100KB and filesize < 600KB and macho and $magic and $header and $main and all of ($f*) and #word_with_spaces < 3
}
